name: Frontend Deploy to EC2

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. ì†ŒìŠ¤ ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
      - name: Checkout source code
        uses: actions/checkout@v3

      # 2. Node.js ì„¸íŒ…
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18"

      # 3. ì˜ì¡´ì„± ì„¤ì¹˜ ë° ë¹Œë“œ
      - name: Install Dependencies and Build
        run: |
          npm install
          npm run build
          # ì£¼ì˜: Viteë¼ë©´ 'dist', CRAë¼ë©´ 'build' í´ë”ê°€ ìƒì„±ë©ë‹ˆë‹¤.
          # ì•„ë˜ ë‹¨ê³„ì—ì„œ í´ë”ëª…ì„ ê¼­ í™•ì¸í•˜ì„¸ìš”!

      # 4. EC2ë¡œ íŒŒì¼ ì „ì†¡ (ì¼ë‹¨ ì„ì‹œ í´ë”ë¡œ!)
      - name: Copy files to EC2 (Temp)
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_KEY }}
          source: "dist/*" # ğŸ‘ˆ ì—¬ê¸°! ë³¸ì¸ í”„ë¡œì íŠ¸ê°€ build í´ë”ë©´ build/* ë¡œ ìˆ˜ì • í•„ìˆ˜!
          target: "/home/ubuntu/frontend-temp"
          strip_components: 1

      # 5. ì§„ì§œ ìœ„ì¹˜ë¡œ ì´ë™ (Sudo ê¶Œí•œ ì‚¬ìš©)
      - name: Move files to Nginx folder
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_KEY }}
          script: |
            # ê¸°ì¡´ íŒŒì¼ ê¹”ë”í•˜ê²Œ ì§€ìš°ê¸°
            sudo rm -rf /var/www/html/*

            # ì„ì‹œ í´ë”ì—ì„œ Nginx í´ë”ë¡œ ì´ë™ (ê´€ë¦¬ì ê¶Œí•œ)
            sudo mv /home/ubuntu/frontend-temp/* /var/www/html/

            # ì„ì‹œ í´ë” ê»ë°ê¸° ì‚­ì œ
            rm -rf /home/ubuntu/frontend-temp
